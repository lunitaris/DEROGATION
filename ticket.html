<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ticket — DerogManager</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/views.css">
  <link rel="stylesheet" href="css/ticket.css">
  <link rel="stylesheet" href="css/timeline.css">
</head>
<body>

  <!-- TOPBAR FIXE -->
  <div id="tp-topbar">
    <div id="tp-topbar-left">
      <a href="index.html" class="tp-back-link" title="Retour au tableau de bord">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
      </a>
      <span class="tp-breadcrumb">
        <span class="tp-brand">DerogManager</span>
        <span class="tp-sep">/</span>
        <span id="tp-breadcrumb-ticket" class="tp-crumb-ticket">—</span>
        <span id="tp-breadcrumb-title" class="tp-crumb-title">Chargement…</span>
      </span>
    </div>
    <div id="tp-topbar-right">
      <button class="tp-btn-email" onclick="tpCopyEmail('info')" title="Copier email — Relance info">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><polyline points="2,4 12,13 22,4"/></svg>
        Relance info
      </button>
      <button class="tp-btn-email" onclick="tpCopyEmail('status')" title="Copier email — Point statut">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><polyline points="2,4 12,13 22,4"/></svg>
        Point statut
      </button>
      <button class="tp-btn-email" onclick="tpCopyEmail('expiry')" title="Copier email — Alerte expiration">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><polyline points="2,4 12,13 22,4"/></svg>
        Alerte expiration
      </button>
      <div class="tp-sep-v"></div>
      <button class="tp-btn-icon" onclick="tpOpenEdit()" title="Modifier la dérogation">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      </button>
      <button class="tp-btn-icon" onclick="toggleTheme()" title="Changer le thème">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      </button>
      <button class="tp-btn-danger" onclick="tpConfirmDelete()" title="Supprimer la dérogation">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"/></svg>
      </button>
    </div>
  </div>

  <!-- BANDEAU IDENTITÉ FIXE -->
  <div id="tp-identity-strip">
    <div id="tp-identity-content"><!-- renderIdentityStrip() --></div>
  </div>

  <!-- ZONE DE TRAVAIL : 2 PANNEAUX -->
  <div id="tp-workspace">

    <!-- PANNEAU GAUCHE — actions / opérationnel -->
    <div id="tp-left-pane">
      <div id="tp-risk-profile"><!-- renderRiskProfile() --></div>
      <div id="tp-next-steps"><!-- renderNextSteps() --></div>
      <div id="tp-meeting-notes"><!-- renderMeetingNotes() --></div>
      <div id="tp-quick-notes"><!-- renderQuickNotes() --></div>
    </div>

    <!-- PANNEAU DROIT — documentation / historique -->
    <div id="tp-right-pane">
      <div id="tp-lifecycle"><!-- renderLifecycle() --></div>
      <div id="tp-dossier-row">
        <div id="tp-dossier"><!-- renderDossier() --></div>
        <div id="tp-timeline"><!-- renderTimelineSection() --></div>
      </div>
      <div id="tp-journal"><!-- renderJournalShell() --></div>
      <div id="tp-auto-history"><!-- renderAutoHistory() --></div>
    </div>

  </div>

  <!-- TOAST -->
  <div id="tp-toast" class="tp-toast" aria-live="polite"></div>

  <!-- DIALOG CONFIRMATION -->
  <div id="tp-confirm-overlay" class="tp-confirm-overlay" style="display:none">
    <div class="tp-confirm-box">
      <p id="tp-confirm-msg" class="tp-confirm-msg">Supprimer cette dérogation ?</p>
      <p class="tp-confirm-sub">Cette action est irréversible.</p>
      <div class="tp-confirm-actions">
        <button class="btn-cancel" onclick="document.getElementById('tp-confirm-overlay').style.display='none'">Annuler</button>
        <button id="tp-confirm-ok" class="btn-danger">Supprimer</button>
      </div>
    </div>
  </div>

  <!-- MODALE EXPANSION (meeting notes & quick notes) -->
  <div id="tp-expand-modal" class="tp-expand-overlay" onclick="if(event.target===this)tpCloseExpandModal()" style="display:none">
    <div class="tp-expand-box">
      <div class="tp-expand-header">
        <span class="tp-expand-title" id="tp-expand-title"></span>
        <button class="tp-expand-close" onclick="tpCloseExpandModal()" title="Fermer (Échap)">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <textarea id="tp-expand-ta" class="tp-expand-ta" oninput="tpScheduleExpandSave()" placeholder="…"></textarea>
      <div class="tp-expand-footer">
        <span class="tp-expand-hint" id="tp-expand-hint"></span>
        <button class="tp-expand-done" onclick="tpCloseExpandModal()">Fermer</button>
      </div>
    </div>
  </div>

  <!-- MODAL MOT DE PASSE MAÎTRE — affiché si la clé ne peut pas être héritée de l'onglet parent -->
  <div id="modal-crypto" class="hidden">
    <div class="crypto-box"><!-- contenu injecté par modal-crypto.js --></div>
  </div>

  <script src="js/sjcl.min.js"></script>
  <script src="js/crypto.js"></script>
  <script src="js/constants.js"></script>
  <script src="js/store.js"></script>
  <script src="js/helpers.js"></script>
  <script src="js/render-shared.js"></script>
  <script src="js/modal-crypto.js"></script>
  <script src="js/ticket-actions.js"></script>
  <script src="js/ticket-timeline.js"></script>
  <script src="js/ticket.js"></script>

  <!-- Tooltip timeline (positionné fixe par CSS) -->
  <div id="tp-tooltip" class="tp-tooltip"></div>
</body>
</html>
